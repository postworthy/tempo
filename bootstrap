#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$ROOT_DIR"

RUN_VERIFY=1
INIT_PROJECT=0

for arg in "$@"; do
  case "$arg" in
    --no-verify)
      RUN_VERIFY=0
      ;;
    --init-project)
      INIT_PROJECT=1
      ;;
    --help|-h)
      cat <<'HELP'
Usage: ./bootstrap [--no-verify] [--init-project]

Options:
  --no-verify    Skip pnpm verify at the end.
  --init-project Reset project records to a clean starter baseline.
HELP
      exit 0
      ;;
    *)
      echo "[bootstrap] Unknown argument: $arg"
      echo "[bootstrap] Use ./bootstrap --help"
      exit 1
      ;;
  esac
done

echo "[bootstrap] Tempo local bootstrap starting..."
echo "[bootstrap] Assumes repository is already cloned. Installing git is out of scope."

if ! command -v node >/dev/null 2>&1; then
  echo "[bootstrap] Node.js is missing."
  echo "[bootstrap] Install Node.js 20+ (for example from https://nodejs.org/) and rerun ./bootstrap."
  exit 1
fi

if ! command -v pnpm >/dev/null 2>&1; then
  if command -v corepack >/dev/null 2>&1; then
    PM_VERSION="$(node -p "require('./package.json').packageManager")"
    echo "[bootstrap] pnpm not found. Attempting safe user-level activation via corepack ($PM_VERSION)."
    corepack enable
    corepack prepare "$PM_VERSION" --activate
  else
    echo "[bootstrap] pnpm is missing and corepack is unavailable."
    echo "[bootstrap] Install pnpm 9.x (for example: npm install -g pnpm@9) and rerun ./bootstrap."
    exit 1
  fi
fi

node scripts/bootstrap-check.mjs

if [[ "$INIT_PROJECT" -eq 1 ]]; then
  echo "[bootstrap] Initializing project records to starter baseline..."
  ./scripts/init-project.sh
fi

echo "[bootstrap] Installing dependencies..."
pnpm install

if [[ "$RUN_VERIFY" -eq 1 ]]; then
  echo "[bootstrap] Running canonical verification (pnpm verify)..."
  pnpm verify
else
  echo "[bootstrap] Skipping verification (--no-verify). Run 'pnpm verify' next."
fi

echo "[bootstrap] Done."
